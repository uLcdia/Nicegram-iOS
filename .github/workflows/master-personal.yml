name: Master Personal Build

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: macos-latest

    env:
      BAZEL_USER_ROOT: /private/var/tmp/_bazel_telegram
      BUILD_WORKING_DIR: /Users/telegram/build-working-dir
      SOURCE_PATH: /Users/telegram/telegram-ios

    steps:
      # Step 1: Checkout the main repository (without submodules)
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: '0'

      # Step 2: Initialize Submodules (SKIPPING tgcalls)
      - name: Initialize Submodules (Skip tgcalls)
        run: |
          set -x
          git submodule init
          git -c submodule."submodules/TgVoipWebrtc/tgcalls".update=none submodule update --recursive
          
      # Step 3: Patch Private Dependencies
      - name: Patch Private Dependencies
        run: |
          set -x
          find . -name "BUILD" -o -name "BUILD.bazel" | \
          xargs sed -i '' \
          -e 's/.*nicegram_wallet_ios.*/# &/' \
          -e 's/.*nicegram_assistant_ios.*/# &/'
          
      # Step 4: Verify Patch
      - name: Verify Patch
        run: |
          set -x
          echo "---"
          echo "Verifying 'nicegram_wallet_ios' is patched:"
          grep -r "nicegram_wallet_ios" . --exclude-dir=".git" || true
          echo "---"
          echo "Verifying 'nicegram_assistant_ios' is patched:"
          grep -r "nicegram_assistant_ios" . --exclude-dir=".git" || true
          echo "---"
          echo "Verification complete. Review the lines above."
          
      # Step 5: Set the correct Xcode version
      - name: Set active Xcode path
        run: |
          XCODE_VERSION=$(cat versions.json | python3 -c 'import json,sys;obj=json.load(sys.stdin);print(obj["xcode"]);')
          sudo xcode-select -s /Applications/Xcode_$XCODE_VERSION.app/Contents/Developer

      # Step 6: Create the same directory structure the build expects
      - name: Create canonical source directory
        run: |
          set -x
          sudo mkdir /Users/telegram
          sudo chown -R $(whoami) /Users/telegram
          cp -R $GITHUB_WORKSPACE /Users/telegram/
          mv /Users/telegram/$(basename $GITHUB_WORKSPACE) /Users/telegram/telegram-ios

      # Step 7: Create the (correct) build configuration file
      - name: Create Build Configuration
        run: |
          echo "Creating my_config.json"
          printf '{\n' > $SOURCE_PATH/my_config.json
          printf '  "bundle_id": "app.nicegram",\n' >> $SOURCE_PATH/my_config.json
          printf '  "api_id": "%s",\n' "${{ secrets.API_ID }}" >> $SOURCE_PATH/my_config.json
          printf '  "api_hash": "%s",\n' "${{ secrets.API_HASH }}" >> $SOURCE_PATH/my_config.json
          printf '  "team_id": "DUMMYTEAMID",\n' >> $SOURCE_PATH/my_config.json
          printf '  "app_center_id": "0",\n' >> $SOURCE_PATH/my_config.json
          printf '  "is_internal_build": false,\n' >> $SOURCE_PATH/my_config.json
          printf '  "is_appstore_build": false,\n' >> $SOURCE_PATH/my_config.json
          printf '  "appstore_id": "0",\n' >> $SOURCE_PATH/my_config.json
          printf '  "app_specific_url_scheme": "tg",\n' >> $SOURCE_PATH/my_config.json
          printf '  "premium_iap_product_id": "org.telegram.telegramPremium.monthly",\n' >> $SOURCE_PATH/my_config.json
          printf '  "enable_siri": false,\n' >> $SOURCE_PATH/my_config.json
          printf '  "enable_icloud": false,\n' >> $SOURCE_PATH/my_config.json
          printf '  "google_client_scheme": "com.google.dummy",\n' >> $SOURCE_PATH/my_config.json
          printf '  "ng_env": "personal"\n' >> $SOURCE_PATH/my_config.json
          printf '}\n' >> $SOURCE_PATH/my_config.json

          echo "Configuration file created:"
          cat $SOURCE_PATH/my_config.json

      # Step 8: Generate the Xcode Project (This step is correct and working)
      - name: Generate Xcode Project
        run: |
          set -x
          cd $SOURCE_PATH
          
          python3 build-system/Make/Make.py generateProject \
            --buildNumber ${{ github.run_number }} \
            --configurationPath $SOURCE_PATH/my_config.json \
            --xcodeManagedCodesigning \
            --disableProvisioningProfiles
            
      # Step 9: List Generated Files
      - name: List Generated Files
        run: |
          set -x
          echo "Listing contents of $SOURCE_PATH/Telegram"
          ls -l $SOURCE_PATH/Telegram

      # Step 10: List Project Schemes
      - name: List Project Schemes
        run: |
          set -x
          echo "Listing schemes for $SOURCE_PATH/Telegram/Telegram.xcodeproj"
          xcodebuild -list -project "$SOURCE_PATH/Telegram/Telegram.xcodeproj"

      # Step 11: Build the Unsigned App (FIXED: use 'build' action)
      - name: Build Unsigned App
        run: |
          set -x
          cd $SOURCE_PATH
          
          # Define our output directories
          BUILD_APP_DIR="$BUILD_WORKING_DIR/build_output"
          BUILD_IPA_DIR="$BUILD_WORKING_DIR/archive"
          FINAL_IPA_PATH="$BUILD_IPA_DIR/Nicegram.ipa"
          
          mkdir -p $BUILD_APP_DIR
          mkdir -p $BUILD_IPA_DIR

          # Use 'build' instead of 'archive'
          # Force the output .app to our build_output directory
          xcodebuild build \
            -project "Telegram/Telegram.xcodeproj" \
            -scheme "Telegram" \
            -configuration "Release" \
            -destination "generic/platform=iOS" \
            "CONFIGURATION_BUILD_DIR=$BUILD_APP_DIR" \
            "CODE_SIGN_IDENTITY=" \
            "CODE_SIGNING_REQUIRED=NO" \
            "CODE_SIGNING_ALLOWED=NO"
          
          # Set IPA_PATH for subsequent steps
          echo "IPA_PATH=$FINAL_IPA_PATH" >> $GITHUB_ENV
          
          # Debug print for you
          echo "---"
          echo "Final IPA will be at: $FINAL_IPA_PATH"
          echo "---"

      # Step 12: Manually package the unsigned .app into a .ipa
      - name: Package Unsigned IPA
        run: |
          set -x
          # Go to the directory where Telegram.app was built
          cd $BUILD_WORKING_DIR/build_output
          
          mkdir -p Payload
          # Move the .app inside Payload, renaming it to Nicegram.app
          mv "Telegram.app" "Payload/Nicegram.app"
          
          # Create the .ipa file in the archive directory
          zip -r "${{ env.IPA_PATH }}" "Payload"

      # Step 13: Upload the .ipa as a build artifact
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Nicegram-unsigned
          path: ${{ env.IPA_PATH }}
          retention-days: 7
