name: Master Personal Build

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: macos-latest

    env:
      BAZEL_USER_ROOT: /private/var/tmp/_bazel_telegram
      BUILD_WORKING_DIR: /Users/telegram/build-working-dir
      SOURCE_PATH: /Users/telegram/telegram-ios

    steps:
      # Step 1: Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: '0'

      # Step 2: Initialize Submodules (Skip tgcalls)
      - name: Initialize Submodules (Skip tgcalls)
        run: |
          set -x
          git submodule init
          git -c submodule."submodules/TgVoipWebrtc/tgcalls".update=none submodule update --recursive
          
      # Step 3: Patch Private Dependencies (BUILD/BUILD.bazel)
      - name: Patch Private Dependencies
        run: |
          set -x
          find . -name "BUILD" -o -name "BUILD.bazel" | \
          xargs sed -i '' \
          -e 's/.*nicegram_wallet_ios.*/# &/' \
          -e 's/.*nicegram_assistant_ios.*/# &/'
          
      # Step 4: Set the correct Xcode version
      - name: Set active Xcode path
        run: |
          XCODE_VERSION=$(cat versions.json | python3 -c 'import json,sys;obj=json.load(sys.stdin);print(obj["xcode"]);')
          sudo xcode-select -s /Applications/Xcode_$XCODE_VERSION.app/Contents/Developer

      # Step 5: Create the same directory structure the build expects
      - name: Create canonical source directory
        run: |
          set -x
          sudo mkdir /Users/telegram
          sudo chown -R $(whoami) /Users/telegram
          cp -R $GITHUB_WORKSPACE /Users/telegram/
          mv /Users/telegram/$(basename $GITHUB_WORKSPACE) /Users/telegram/telegram-ios

# Step 6: Create the (correct) build configuration file
      - name: Create Build Configuration
        run: |
          echo "Creating my_config.json"
          printf '{\n' > $SOURCE_PATH/my_config.json
          printf '  "bundle_id": "app.nicegram",\n' >> $SOURCE_PATH/my_config.json
          printf '  "api_id": "%s",\n' "${{ secrets.API_ID }}" >> $SOURCE_PATH/my_config.json
          printf '  "api_hash": "%s",\n' "${{ secrets.API_HASH }}" >> $SOURCE_PATH/my_config.json
          printf '  "team_id": "DUMMYTEAMID",\n' >> $SOURCE_PATH/my_config.json
          printf '  "app_center_id": "0",\n' >> $SOURCE_PATH/my_config.json
          printf '  "is_internal_build": false,\n' >> $SOURCE_PATH/my_config.json
          printf '  "is_appstore_build": false,\n' >> $SOURCE_PATH/my_config.json
          printf '  "appstore_id": "0",\n' >> $SOURCE_PATH/my_config.json
          printf '  "app_specific_url_scheme": "tg",\n' >> $SOURCE_PATH/my_config.json
          printf '  "premium_iap_product_id": "org.telegram.telegramPremium.monthly",\n' >> $SOURCE_PATH/my_config.json
          printf '  "enable_siri": false,\n' >> $SOURCE_PATH/my_config.json
          printf '  "enable_icloud": false,\n' >> $SOURCE_PATH/my_config.json
          printf '  "google_client_scheme": "com.google.dummy",\n' >> $SOURCE_PATH/my_config.json
          printf '  "ng_env": "personal"\n' >> $SOURCE_PATH/my_config.json
          printf '}\n' >> $SOURCE_PATH/my_config.json

      # Step 7: Patch Make.py to fix the broken --bazelArguments flag
      - name: Patch Make.py
        run: |
          set -x
          cd $SOURCE_PATH/build-system/Make
          
          # Use Python to read, patch, and rewrite the Make.py file.
          python3 -c "
          with open('Make.py', 'r') as f:
              lines = f.readlines()
          
          # Find insertion points
          import_point = -1
          build_func_point = -1
          invoke_func_point = -1
          
          for i, line in enumerate(lines):
              # Find a known import to insert after
              if 'import glob' in line and import_point == -1:
                  import_point = i + 1
              # Find the line in the 'build' function to insert after
              if 'bazel_command_line.set_enable_sandbox(arguments.sandbox)' in line:
                  build_func_point = i + 1
              # Find the line in the 'invoke_build' function to insert before
              if 'combined_arguments += self.common_args' in line and 'invoke_build' in ''.join(lines[max(0, i-15):i]):
                  invoke_func_point = i
          
          # 1. Add 'import shlex'
          if import_point != -1:
              lines.insert(import_point, 'import shlex\n')
              # Adjust other insertion points
              build_func_point += 1
              invoke_func_point += 1
          
          # 2. Fix 'build' function to read the argument
          if build_func_point != -1:
              # Get indentation from the line *before* the insertion point
              indent = lines[build_func_point - 1][:len(lines[build_func_point - 1]) - len(lines[build_func_point - 1].lstrip())]
              lines.insert(build_func_point, f\"{indent}if arguments.bazelArguments is not None: bazel_command_line.add_additional_args(arguments.bazelArguments)\n\")
              invoke_func_point += 1 # Adjust next insertion point
          
          # 3. Fix 'invoke_build' function to use the argument
          if invoke_func_point != -1:
              # Get indentation from the line *at* the insertion point
              indent = lines[invoke_func_point][:len(lines[invoke_func_point]) - len(lines[invoke_func_point].lstrip())]
              lines.insert(invoke_func_point, f\"{indent}if self.additional_args is not None: combined_arguments += shlex.split(self.additional_args)\n\")
          
          # Write the patched file out
          with open('Make.py.patched', 'w') as f:
              f.writelines(lines)
          "
          
          # Replace the original - This is now a BASH command
          mv Make.py.patched Make.py
          
          echo "--- Make.py patched ---"
          echo "Verifying patch 1 (import):"
          grep "import shlex" Make.py
          echo "Verifying patch 2 (build func):"
          grep "bazelArguments is not None" Make.py
          echo "Verifying patch 3 (invoke func):"
          grep "additional_args is not None" Make.py

      # Step 8: Build Unsigned App (using patched Make.py)
      - name: Build Unsigned App
        run: |
          set -x
          cd $SOURCE_PATH
          
          mkdir -p $BUILD_WORKING_DIR/artifacts
          
          # Note the order: global args like --bazelArguments come BEFORE the 'build' command
          python3 build-system/Make/Make.py \
            --bazelArguments="--//Telegram:disableProvisioningProfiles" \
            build \
            --buildNumber ${{ github.run_number }} \
            --configuration=release_arm64 \
            --configurationPath $SOURCE_PATH/my_config.json \
            --xcodeManagedCodesigning \
            --outputBuildArtifactsPath $BUILD_WORKING_DIR/artifacts
          
          # Set IPA_PATH for the upload step
          echo "IPA_PATH=$BUILD_WORKING_DIR/artifacts/Telegram.ipa" >> $GITHUB_ENV
          
          # Debug output
          echo "---"
          echo "Build complete. Artifacts at $BUILD_WORKING_DIR/artifacts"
          ls -l $BUILD_WORKING_DIR/artifacts
          echo "IPA_PATH is ${{ env.IPA_PATH }}"
          echo "---"

      # Step 9: Rename and Upload Artifact
      - name: Rename and Upload Artifact
        run: |
          set -x
          # The script names it Telegram.ipa, let's rename it
          mv "${{ env.IPA_PATH }}" "$BUILD_WORKING_DIR/artifacts/Nicegram.ipa"
          echo "RENAMED_IPA_PATH=$BUILD_WORKING_DIR/artifacts/Nicegram.ipa" >> $GITHUB_ENV
        
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Nicegram-unsigned
          path: ${{ env.RENAMED_IPA_PATH }}
          retention-days: 7
