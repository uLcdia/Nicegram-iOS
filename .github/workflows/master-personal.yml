name: Master Personal Build

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: macos-latest

    env:
      BAZEL_USER_ROOT: /private/var/tmp/_bazel_telegram
      BUILD_WORKING_DIR: /Users/telegram/build-working-dir
      SOURCE_PATH: /Users/telegram/telegram-ios
      BUNDLE_ID: app.nicegram

    steps:
      # Step 1: Checkout the code
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: '0'

      # Step 2: Set the correct Xcode version
      - name: Set active Xcode path
        run: |
          XCODE_VERSION=$(cat versions.json | python3 -c 'import json,sys;obj=json.load(sys.stdin);print(obj["xcode"]);')
          sudo xcode-select -s /Applications/Xcode_$XCODE_VERSION.app/Contents/Developer

      # Step 3: Create the same directory structure the build expects
      - name: Create canonical source directory
        run: |
          set -x
          sudo mkdir /Users/telegram
          sudo chown -R $(whoami) /Users/telegram
          cp -R $GITHUB_WORKSPACE /Users/telegram/
          mv /Users/telegram/$(basename $GITHUB_WORKSPACE) /Users/telegram/telegram-ios

      # Step 4: Build the app WITHOUT code signing
      - name: Build Unsigned App
        run: |
          set -x
          cd $SOURCE_PATH
          mkdir -p $BUILD_WORKING_DIR/archive

          # Build the .xcarchive without signing
          # We must guess the scheme name here. 'Nicegram' is a common convention.
          # If this fails, it might be 'Telegram'. Check your .xcworkspace for scheme names.
          xcodebuild archive \
            -workspace "Telegram.xcworkspace" \
            -scheme "Nicegram" \
            -configuration "Release" \
            -archivePath "$BUILD_WORKING_DIR/archive/Nicegram.xcarchive" \
            -destination "generic/platform=iOS" \
            "CODE_SIGN_IDENTITY=" \
            "CODE_SIGNING_REQUIRED=NO" \
            "CODE_SIGNING_ALLOWED=NO"

      # Step 5: Manually package the unsigned .app into a .ipa
      - name: Package Unsigned IPA
        run: |
          set -x
          cd $BUILD_WORKING_DIR/archive
          
          # Create the Payload folder
          mkdir -p Payload

          # Copy the .app from the archive into the Payload folder
          cp -R "Nicegram.xcarchive/Products/Applications/Nicegram.app" "Payload/Nicegram.app"
          
          # Zip the Payload folder to create the .ipa
          zip -r "Nicegram.ipa" "Payload"
          
          echo "IPA_PATH=$BUILD_WORKING_DIR/archive/Nicegram.ipa" >> $GITHUB_ENV

      # Step 6: Upload the .ipa as a build artifact
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Nicegram-unsigned
          path: ${{ env.IPA_PATH }}
          retention-days: 7
